# ç«¯å£æ˜ å°„èˆ‡é…ç½®çš„é—œä¿‚èªªæ˜

## æ¶æ§‹å±¤æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å¤–éƒ¨è¨ªå•å±¤ (å®¢æˆ¶ç«¯)                                        â”‚
â”‚    - https://localhost:8444  (è¨ªå•ä»£ç†æœå‹™)                  â”‚
â”‚    - https://localhost:9443  (è¨ªå• Admin API)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Docker ç«¯å£æ˜ å°„å±¤ (docker-compose.yml)                    â”‚
â”‚    ports:                                                    â”‚
â”‚      - "8444:8443"   # ä¸»æ©Ÿ 8444 â†’ å®¹å™¨ 8443                 â”‚
â”‚      - "9443:9443"   # ä¸»æ©Ÿ 9443 â†’ å®¹å™¨ 9443 (ä¸€å°ä¸€)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å®¹å™¨å…§éƒ¨ç¶²çµ¡å±¤ (æ‡‰ç”¨ç¨‹åºè¦–è§’)                              â”‚
â”‚    config.json:                                              â”‚
â”‚      "listen": "0.0.0.0:8443"    # æ‡‰ç”¨ç›£è½å®¹å™¨å…§ 8443       â”‚
â”‚    Admin API:                                                â”‚
â”‚      ADMIN_API_ADDR=0.0.0.0:9443 # Admin ç›£è½å®¹å™¨å…§ 9443     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é‡è¦æ¦‚å¿µ

### 1. ç«¯å£æ˜ å°„ä¸å½±éŸ¿é…ç½®
- **config.json ç®¡ç†çš„æ˜¯å®¹å™¨å…§éƒ¨ç«¯å£**
- Admin API ä¿®æ”¹é…ç½®æ™‚ï¼Œä¿®æ”¹çš„æ˜¯å®¹å™¨å…§éƒ¨çš„ç›£è½åœ°å€
- Docker çš„ç«¯å£æ˜ å°„ç¨ç«‹æ–¼æ‡‰ç”¨é…ç½®

### 2. é€šé Admin API ä¿®æ”¹ listen ç«¯å£

#### å ´æ™¯ 1: ä¿®æ”¹ç‚º 8080ï¼ˆå¯è¡Œä½†éœ€æ³¨æ„ï¼‰
```json
// é€šé Admin API ä¿®æ”¹
{
  "listen": "0.0.0.0:8080"
}
```

**çµæœ**ï¼š
- âœ… æ‡‰ç”¨åœ¨å®¹å™¨å…§ç›£è½ 8080
- âŒ å¤–éƒ¨ç„¡æ³•è¨ªå•ï¼ˆå› ç‚º docker-compose.yml æ˜ å°„çš„æ˜¯ 8443ï¼‰
- âš ï¸ éœ€è¦åŒæ™‚ä¿®æ”¹ docker-compose.ymlï¼š`"8444:8080"`

#### å ´æ™¯ 2: ä¿æŒ 8443ï¼ˆæ¨è–¦ï¼‰
```json
// ä¿æŒåŸå€¼
{
  "listen": "0.0.0.0:8443"
}
```

**çµæœ**ï¼š
- âœ… æ‡‰ç”¨åœ¨å®¹å™¨å…§ç›£è½ 8443
- âœ… å¤–éƒ¨é€šé 8444 è¨ªå•
- âœ… é…ç½®èˆ‡æ˜ å°„ä¸€è‡´

### 3. é…ç½®ç®¡ç†ç¯„åœ

#### âœ… Admin API å¯ä»¥ä¿®æ”¹ï¼ˆå®¹å™¨å…§éƒ¨ï¼‰
- `listen` - ä»£ç†ç›£è½åœ°å€ï¼ˆå®¹å™¨å…§ï¼‰
- `target` - å¾Œç«¯ç›®æ¨™åœ°å€
- `log_level` - æ—¥èªŒç´šåˆ¥
- `buffer_size` - ç·©è¡å€å¤§å°
- `connection_timeout` - é€£æ¥è¶…æ™‚
- `client_cert_mode` - å®¢æˆ¶ç«¯è­‰æ›¸æ¨¡å¼

#### âŒ Admin API ç„¡æ³•ä¿®æ”¹ï¼ˆDocker å±¤ï¼‰
- ç«¯å£æ˜ å°„ï¼ˆéœ€ä¿®æ”¹ docker-compose.ymlï¼‰
- å·æ›è¼‰ï¼ˆéœ€ä¿®æ”¹ docker-compose.ymlï¼‰
- ç’°å¢ƒè®Šé‡ï¼ˆéƒ¨åˆ†ï¼Œéœ€ä¿®æ”¹ docker-compose.ymlï¼‰

## å¯¦éš›æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: ä¿®æ”¹ log_levelï¼ˆâœ… å®Œå…¨åœ¨æ‡‰ç”¨å±¤ï¼‰
```bash
# é€šé Admin API ä¿®æ”¹
PATCH /api/v1/config
{
  "changes": [
    {"name": "log_level", "value": "info"}
  ]
}

# é‡å•Ÿå¾Œç”Ÿæ•ˆ
docker compose restart quantum-safe-proxy

# âœ… é…ç½®ä¿æŒï¼Œç„¡éœ€ä¿®æ”¹ docker-compose.yml
```

### æ¡ˆä¾‹ 2: ä¿®æ”¹ listen ç«¯å£ï¼ˆâš ï¸ éœ€è¦å”èª¿ï¼‰
```bash
# æ–¹å¼ 1: åªä¿®æ”¹é…ç½®ï¼ˆä¸æ¨è–¦ï¼‰
# é€šé Admin API ä¿®æ”¹ listen ç‚º 0.0.0.0:9000
# âŒ å•é¡Œ: docker-compose.yml ä»æ˜ å°„ 8443ï¼Œå°è‡´ç„¡æ³•è¨ªå•

# æ–¹å¼ 2: åŒæ™‚ä¿®æ”¹ï¼ˆæ¨è–¦ï¼‰
# 1. ä¿®æ”¹ docker-compose.yml
   ports:
     - "8444:9000"  # æ”¹ç‚ºæ˜ å°„æ–°ç«¯å£

# 2. é€šé Admin API ä¿®æ”¹ listen ç‚º 0.0.0.0:9000

# 3. é‡å•Ÿå®¹å™¨
   docker compose up -d

# âœ… é…ç½®å’Œæ˜ å°„ä¸€è‡´ï¼Œå¯ä»¥æ­£å¸¸è¨ªå•
```

### æ¡ˆä¾‹ 3: ä¿®æ”¹ targetï¼ˆâœ… å®Œå…¨åœ¨æ‡‰ç”¨å±¤ï¼‰
```bash
# é€šé Admin API ä¿®æ”¹
PATCH /api/v1/config
{
  "changes": [
    {"name": "target", "value": "backend:8080"}
  ]
}

# âœ… åªæ¶‰åŠå®¹å™¨å…§éƒ¨çš„è½‰ç™¼é‚è¼¯ï¼Œç„¡éœ€ä¿®æ”¹ docker-compose.yml
```

## é…ç½®æŒä¹…åŒ–é©—è­‰

### æ¸¬è©¦ï¼šä¿®æ”¹ log_level å¾Œé‡å•Ÿ
```bash
# 1. ç•¶å‰ç‹€æ…‹
docker-compose.yml:  ports: ["8444:8443"]
config.json:         "listen": "0.0.0.0:8443"
æ‡‰ç”¨å¯¦éš›ç›£è½:         0.0.0.0:8443

# 2. é€šé Admin API ä¿®æ”¹ log_level ç‚º info
curl -X PATCH https://localhost:9443/api/v1/config \
  -H "X-API-Key: admin:xxx" \
  -d '{"changes": [{"name": "log_level", "value": "info"}]}'

# 3. æª¢æŸ¥ config.json å·²æ›´æ–°
cat config.json | jq '.log_level'
# è¼¸å‡º: "info"

# 4. é‡å•Ÿå®¹å™¨
docker compose restart quantum-safe-proxy

# 5. é©—è­‰é…ç½®ä¿æŒ
docker logs quantum-safe-proxy-quantum-safe-proxy-1 | grep "Log level"
# è¼¸å‡º: Log level: info

# 6. ç«¯å£æ˜ å°„ä»ç„¶æœ‰æ•ˆ
curl -k https://localhost:8444
# âœ… å¯ä»¥è¨ªå•ï¼ˆ8444 â†’ 8443 æ˜ å°„ä»ç„¶å·¥ä½œï¼‰
```

## çµè«–

### âœ… ç«¯å£æ˜ å°„ä¸å½±éŸ¿é…ç½®æŒä¹…åŒ–
- ä¿®æ”¹ `log_level`ã€`buffer_size`ã€`connection_timeout` ç­‰é…ç½®
- é‡å•Ÿå¾Œé…ç½®ä¿æŒ
- ç«¯å£æ˜ å°„ç¹¼çºŒå·¥ä½œ

### âš ï¸ åªæœ‰ä¿®æ”¹ listen ç«¯å£éœ€è¦æ³¨æ„
- å¦‚æœé€šé Admin API ä¿®æ”¹ `listen` ç«¯å£
- å¿…é ˆåŒæ™‚æ›´æ–° docker-compose.yml çš„ç«¯å£æ˜ å°„
- å¦å‰‡å¤–éƒ¨ç„¡æ³•è¨ªå•

### ğŸ’¡ æ¨è–¦åšæ³•
1. **æ™®é€šé…ç½®ä¿®æ”¹**ï¼ˆlog_levelã€buffer_size ç­‰ï¼‰
   - ç›´æ¥é€šé Admin API ä¿®æ”¹
   - é‡å•Ÿç”Ÿæ•ˆï¼Œç„¡éœ€ä¿®æ”¹ docker-compose.yml

2. **ç¶²çµ¡ç›¸é—œé…ç½®**ï¼ˆlisten ç«¯å£ï¼‰
   - ä¿æŒ `listen: "0.0.0.0:8443"` ä¸è®Š
   - å¦‚éœ€ä¿®æ”¹ï¼ŒåŒæ­¥æ›´æ–° docker-compose.yml
   - é¿å…é…ç½®å’Œæ˜ å°„ä¸ä¸€è‡´

3. **å¾Œç«¯ç›®æ¨™**ï¼ˆtargetï¼‰
   - ä½¿ç”¨æœå‹™åç¨±ï¼ˆå¦‚ `backend:6001`ï¼‰
   - é€šé Admin API éˆæ´»ä¿®æ”¹
   - ä¸å—ç«¯å£æ˜ å°„å½±éŸ¿

## å¿«é€Ÿæª¢æŸ¥æ¸…å–®

ä¿®æ”¹é…ç½®å‰ï¼Œç¢ºèªï¼š

- [ ] æ˜¯å¦ä¿®æ”¹ `listen` ç«¯å£ï¼Ÿ
  - æ˜¯ â†’ éœ€è¦åŒæ­¥ä¿®æ”¹ docker-compose.yml
  - å¦ â†’ å¯ä»¥ç›´æ¥é€šé Admin API ä¿®æ”¹

- [ ] æ˜¯å¦æ¶‰åŠ Docker å±¤é…ç½®ï¼ˆç«¯å£æ˜ å°„ã€å·æ›è¼‰ï¼‰ï¼Ÿ
  - æ˜¯ â†’ ä¿®æ”¹ docker-compose.yml ä¸¦é‡æ–°éƒ¨ç½²
  - å¦ â†’ Admin API + é‡å•Ÿå³å¯

- [ ] é…ç½®ä¿®æ”¹å¾Œæ˜¯å¦éœ€è¦é‡å•Ÿï¼Ÿ
  - Hot-reloadableï¼šlog_levelã€buffer_sizeã€connection_timeout
  - éœ€è¦é‡å•Ÿï¼šlistenã€targetã€è­‰æ›¸ç›¸é—œé…ç½®
